---
lab:
    title: 'Microsoft Defender for Cloud'
    module: 'Learning Path 3 - Mitigate threats using Microsoft Defender for Cloud'
---

# Learning Path 3: Microsoft Defender for Cloud

## Lab scenario

You are a Security Operations Analyst working at a company that is looking forward to implement a cloud-native application protection platform (CNAPP) designed to protect cloud-based applications from various cyber threats and vulnerabilities. 

You will be enabling Defender for Cloud that combines the capabilities of:
- A cloud security posture management (CSPM) solution that surfaces actions that you can take to prevent breaches
- A cloud workload protection platform (CWPP) with specific protections for servers, containers, storage, databases, and other workloads.

You need to respond to recommendations and security alerts generated by Microsoft Defender for Cloud.

## Lab objectives

In this lab, you will complete the following exercises:

- Exercise 1: Prepare the environment
- Exercise 2: Implement Microsoft Defender for Cloud

> For all the resources in this lab, we are using the **East US** region. Verify with your instructor this is the region to use for class. 

# Instructions

## Exercise 1: Prepare the environment

In this exercise, you will complete the following tasks: 

- Task 1: Deploy an Azure virtual machine
- Task 2: Review current Azure policies


### Task 1: Deploy an Azure virtual machine

In this task, you will create an Azure Virtual Machine to get recommendations from Microsoft Defender for Endpoint.

1. Sign-in to the Azure portal **`https://portal.azure.com/`**.

    >**Note**: Sign in to the Azure portal using an account that has the Owner or Contributor role in the Azure subscription you are using for this lab.

1. Open the Cloud Shell by clicking the first icon in the top right of the Azure Portal. When prompted, select **PowerShell** and **Create storage**. Wait until the Storage Account is created.

1. Ensure **PowerShell** is selected in the drop-down menu in the upper-left corner of the Cloud Shell pane.

1. In the PowerShell session within the Cloud Shell pane, run the following to create a resource group that will be used in this lab:
  
    ```Cloud Shell
    New-AzResourceGroup -Name SC200LP03 -Location 'EastUS'
    ```

1. In the PowerShell session within the Cloud Shell pane, run the following to create a new Azure virtual machine. 

    ```Cloud Shell
    New-AzVm -ResourceGroupName "SC200LP03" -Name "myVM" -Location 'EastUS' -VirtualNetworkName "myVnet" -SubnetName "mySubnet" -SecurityGroupName "myNetworkSecurityGroup" -PublicIpAddressName "myPublicIpAddress" -PublicIpSku Standard -OpenPorts 80,3389 -Size Standard_DS1_v2 
    ```
    
1.  When prompted for credentials:

    |Setting|Value|
    |---|---|
    |User |**localadmin**|
    |Password|**Use the same password as the admin account provided**|

    >**Note**: Wait for the deployment to complete, it should take less than 5 minutes.

1. In the PowerShell session within the Cloud Shell pane, run the following to confirm that the virtual machine named **myVM** was created and its **ProvisioningState** is **Succeeded**.

    ```Cloud Shell
    Get-AzVM -Name 'myVM' -ResourceGroupName 'SC200LP03' | Format-Table
    ```

1. Close the Cloud Shell pane.


### Task 2: Review current Azure policies

In this task, you will review the current assigned policies to later compare with the ones assigned by Microsoft Defender for Endpoint.

1. In the Azure portal, in the **Search resources, services, and docs** text box at the top of the Azure portal page, type **Policy** and press the **Enter** key.

1. On the left blade, click on **Assignments** and take a note of the currently assigned policies.


## Exercise 2: Implement Microsoft Defender for Cloud

In this exercise, you will complete the following tasks:

- Task 1: Configure Microsoft Defender for Cloud
- Task 2: Explore Recommendations and Security posture
- Task 3: Mitigate security alerts


### Task 1: Configure Microsoft Defender for Cloud

In this task, you will on-board and configure Microsoft Defender for Cloud.

1. In the Azure portal, in the **Search resources, services, and docs** text box at the top of the Azure portal page, type **Microsoft Defender for Cloud** and press the **Enter** key.

1. On the **Microsoft Defender for Cloud | Getting started** blade, click **Upgrade**. 

    >**Note:** You might need to refresh the Edge browser and click **Upgrade** again to continue with the next step.
     
1. On the **Microsoft Defender for Cloud | Getting started** blade, in the Install agents tab, scroll down and click **Install agents**.

1. Navigate to **Microsoft Defender for Cloud** and click **Environment Settings** under the *Management* settings, in the vertical menu bar on the left side.

1. On the **Microsoft Defender for Cloud | Environment Settings** blade, click the **Expand all** button and then select the relevant Azure subscription. 

1. On the **Defender plans** blade, click the **Enable all** button to enable all of the Microsoft Defender for Cloud plans.

1. On the top of the settings page, click the **Save** button and wait until the changes are saved. 

    >**Note:** It might take up to 5 minutes to finish. If you see errors while saving the plans repeat the last 2 steps.

1. On the top of the settings page, click the **Settings & monitoring** button.

1. On the *Log analytics agent / Azure Monitor agent* line item, click the **Edit configuration** link.

1. Review the *Agent type*, *Workspace selection* selected option. Under *Security events storage* click the drop down menu and select **Common** and click **Apply**.

1. Click **On** to enable the *Vulnerability assessment for machines* and click **Apply** to accept the *Microsoft Defender vulnerability management* solution.

1. On the top of the settings & monitoring page, click **Continue** to save your changes.

1. On the top of the settings page, click the **Save** button and wait until the changes are saved. 

1. On the left blade, click **Email notifications**.

1. Add the email of you admin account in the **Additional email addresses (separated by commas)** field and click **Save**.

1. On the left blade, click **Security policy**. Read the message under the **Default initiative**.

1. Scroll down and look for the SOC TSP (System and Organization Controls Trust Service Principles) standard. Click the **Enable** button to add this regulatory standard. Read the warning message and click **Yes** to confirm.

1. Click **Add more standards** and select **Name** to order the list. Click **Azure CIS 1.4.0** to review all the Azure policies included in the *CIS Microsoft Azure Foundations Benchmark v1.4.0* initiative definition. **Hint**: You need to scroll down the page.

1. Click **Assign** in the top menu and under *Scope*, select the ellipsis **(...)** button.

1. On the righ pane, select the relevant Azure subscription and click the **Select** button.

1. Click the **Review + create** button followed by clicking the **Create** button.

1. In the Azure portal, in the **Search resources, services, and docs** text box at the top of the Azure portal page, type **Policy** and press the **Enter** key.

1. On the left blade, click on **Assignments** and compare the Initiatives and Policies assigned by Microsoft Defender for Cloud with the ones available in the first exercise and identify which one are coming from enabling Defender Plans and the ones from Regulatory standards.


### Task 2: Explore Recommendations and Security posture

In this task, you will review cloud security posture management (CSPM). The Secure Score information might take 24 hours to calculate.

1. In the Azure portal, in the **Search resources, services, and docs** text box at the top of the Azure portal page, type **Microsoft Defender for Cloud** and press the **Enter** key.

1. Under *General*, select **Recommendations** in the portal menu.

1. Inside the *Search recommendations* text box, type **All network ports** and click on the recommendation shown. 

1. Read the *Description*, *Remediation steps* and *Affected resources*. 

1. Make sure that **myvm** is selected and then click the **Assign owner** button.

1. Click the **Select owner** button and start writing down your admin account email address and select it from the list and click **Back**.

1. Your admin account should now be shown under *Owner*. Select a *Due date* in the future, read the other options and click **Save**.

1. Review the message under the *Status* column and close the recommendation by clicking *x* on the top right.

1. Under *Cloud Security*, select **Security posture** in the portal menu.

1. The Secure score most likely will show *N/A* until the score is calculated.


### Task 3: Mitigate security alerts

In this task, you will load sample security alerts and review the alert details.

1. Under *General*, select **Security alerts** in the portal menu.

1. Select **Sample alerts** from the command bar. **Hint:** you may need to select the ellipsis (...) button from the command bar).

1. In the Create sample alerts (Preview) pane make sure your subscription is selected and that all sample alerts are selected in the *Defender for Cloud plans* area.

1. Click **Create sample alerts**.  

    >**Note:** This sample alert creation process may take a few minutes to complete, wait for notification. 
    
1. Once the *Successfully created sample alerts* message appears, click the **Refresh** button on the middle pane. At least 77 alerts should appear in the *Security alerts* area.

1. Filter by the *Resource type* of your preference and for the alerts that grabbed your attention, perform the following actions:

    - Select the alert. General information about the alert should appear on the right pane.
    - Click the **View full details** button.
    - Review and read the *Alert details* tab.
    - Select the **Take action** tab or select the **Next: Take Action** button at the end of the page.
    - Review the *Take action* information. Notice the sections available to take action depending on the type of alert: Inspect resource context, Mitigate the threat, Prevent future attacks, Trigger automated response and Suppress similar alerts.
    - Close the alert by click on the **x** at the top right of the page.

1. Under *Cloud Security*, select **Workload protections** in the portal menu.

1. Notice the number of alerts generated for today, it should show at least 7 alerts of different severities. **Hint:** You might need to refresh the Edge browser to see them.

1. Go to the right pane and read about the *Most prevalent security alerts* and *Most attacked resources*

# End of lab